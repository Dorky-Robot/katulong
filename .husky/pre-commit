# Run Claude Code review on staged changes (skip if already in Claude Code session)
if [ -z "$CLAUDECODE" ]; then
  echo "pre-commit: running Claude Code review"
  if ! claude --prompt "Review the staged changes for security vulnerabilities, code quality issues, and adherence to the code review checklist in CLAUDE.md. Focus on: auth changes, input validation, error handling, path traversal risks, and any security-critical modifications. If there are any critical issues, fail with exit code 1. If the changes look good or only have minor suggestions, exit with code 0." 2>&1 | tee /tmp/claude-review.log; then
    echo "‚ùå Claude Code review found critical issues. Please address them before committing."
    echo "Review output saved to /tmp/claude-review.log"
    exit 1
  fi
else
  echo "pre-commit: skipping Claude Code review (already in Claude Code session)"
fi

# Run only the tests relevant to staged files

map_to_test() {
  case "$1" in
    lib/ndjson.js)    echo "test/ndjson.test.js" ;;
    lib/http-util.js) echo "test/http-util.test.js" ;;
    lib/auth.js)      echo "test/auth.test.js" ;;
    lib/log.js)       echo "test/log.test.js" ;;
    lib/p2p.js)       echo "test/p2p.test.js" ;;
    server.js)        echo "test/http-util.test.js" ;;
    daemon.js)        echo "test/daemon.integration.js" ;;
    test/*.test.js|test/*.integration.js) echo "$1" ;;
  esac
}

STAGED=$(git diff --cached --name-only --diff-filter=ACMR)
TO_RUN=""

for file in $STAGED; do
  test_file=$(map_to_test "$file")
  if [ -n "$test_file" ]; then
    # Deduplicate: only add if not already present
    case " $TO_RUN " in
      *" $test_file "*) ;;
      *) TO_RUN="$TO_RUN $test_file" ;;
    esac
  fi
done

# Trim leading space
TO_RUN=$(echo "$TO_RUN" | sed 's/^ //')

if [ -z "$TO_RUN" ]; then
  exit 0
fi

echo "pre-commit: running $TO_RUN"
node --test $TO_RUN
