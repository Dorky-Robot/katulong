# Get the staged diff (only what's being committed)
DIFF=$(git diff --cached --diff-filter=ACMR)

if [ -z "$DIFF" ]; then
  exit 0
fi

STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR)

# --- Security scan: block secrets before they reach any reviewer ---

SCRIPT_DIR="$(cd "$(dirname "$0")/../scripts" && pwd)"
source "$SCRIPT_DIR/secrets-scan.sh"
scan_secrets "pre-commit" || exit 1

# --- Deterministic quality checks ---

echo "pre-commit: checking for typos..."
if command -v typos &>/dev/null; then
  if ! typos --format brief; then
    echo ""
    echo "pre-commit: BLOCKED — typos found. Fix them or add to _typos.toml to ignore."
    exit 1
  fi
else
  echo "pre-commit: typos not found — install with: brew install typos-cli"
fi

# --- Run only the tests relevant to staged files ---

map_to_test() {
  case "$1" in
    lib/ndjson.js)    echo "test/ndjson.test.js" ;;
    lib/http-util.js) echo "test/http-util.test.js" ;;
    lib/auth.js)      echo "test/auth.test.js" ;;
    lib/log.js)       echo "test/log.test.js" ;;
    lib/p2p.js)       echo "test/p2p.test.js" ;;
    server.js)        echo "test/http-util.test.js" ;;
    daemon.js)        echo "test/daemon.integration.js" ;;
    test/*.test.js|test/*.integration.js) echo "$1" ;;
  esac
}

TO_RUN=""

while IFS= read -r file; do
  [ -z "$file" ] && continue
  test_file=$(map_to_test "$file")
  if [ -n "$test_file" ]; then
    # Deduplicate: only add if not already present
    case " $TO_RUN " in
      *" $test_file "*) ;;
      *) TO_RUN="$TO_RUN $test_file" ;;
    esac
  fi
done <<< "$STAGED_FILES"

# Trim leading space
TO_RUN=$(echo "$TO_RUN" | sed 's/^ //')

if [ -n "$TO_RUN" ]; then
  echo "pre-commit: running $TO_RUN"
  node --test $TO_RUN
fi

echo "pre-commit: all checks passed"
exit 0
