<!DOCTYPE html>
<html lang="en" data-theme="auto">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#1e1e2e">
  <title>Katulong — Trust Certificate</title>
  <link rel="icon" href="/favicon.ico" sizes="32x32">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --font-mono: 'JetBrains Mono', monospace;
      --bg: #1e1e2e;
      --bg-surface: #313244;
      --bg-input: #1e1e2e;
      --border: #45475a;
      --text: #cdd6f4;
      --text-muted: #a6adc8;
      --text-dim: #6c7086;
      --accent: #45475a;
      --accent-active: #cba6f7;
      --success: #a6e3a1;
      --danger: #f38ba8;
      --focus-ring: rgba(137,180,250,0.5);
    }

    [data-theme="light"] {
      --bg: #eff1f5;
      --bg-surface: #ffffff;
      --bg-input: #e6e9ef;
      --border: #ccd0da;
      --text: #4c4f69;
      --text-muted: #6c6f85;
      --text-dim: #9ca0b0;
      --accent: #ccd0da;
      --accent-active: #8839ef;
      --success: #40a02b;
      --danger: #d20f39;
      --focus-ring: rgba(30,102,245,0.4);
    }

    @media (prefers-color-scheme: light) {
      [data-theme="auto"] {
        --bg: #eff1f5;
        --bg-surface: #ffffff;
        --bg-input: #e6e9ef;
        --border: #ccd0da;
        --text: #4c4f69;
        --text-muted: #6c6f85;
        --text-dim: #9ca0b0;
        --accent: #ccd0da;
        --accent-active: #8839ef;
        --success: #40a02b;
        --danger: #d20f39;
        --focus-ring: rgba(30,102,245,0.4);
      }
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      min-height: 100%; background: var(--bg); color: var(--text);
      font-family: var(--font-mono);
    }

    body {
      display: flex; align-items: center; justify-content: center;
      padding: 1rem;
    }

    .trust-card {
      background: var(--bg-surface); border: 1px solid var(--border);
      border-radius: 0.75rem; padding: 2rem; width: min(440px, 100%);
    }

    h1 { font-size: 1.25rem; font-weight: 500; margin-bottom: 0.25rem; }

    .subtitle {
      color: var(--text-muted); font-size: 0.8125rem; margin-bottom: 1.5rem;
    }

    .download-btn {
      display: flex; align-items: center; justify-content: center;
      width: 100%; height: 2.75rem; border: none; border-radius: 0.5rem;
      background: var(--accent-active); color: #1e1e2e;
      font-size: 0.875rem; font-family: var(--font-mono); font-weight: 500;
      cursor: pointer; text-decoration: none; margin-bottom: 1rem;
    }
    .download-btn:active { opacity: 0.8; }

    .steps {
      list-style: none; padding: 0; margin: 0 0 1.5rem;
      color: var(--text-muted); font-size: 0.8125rem; line-height: 1.7;
    }
    .steps li { padding: 0.2rem 0; }
    .steps li::before {
      content: attr(data-step) ". ";
      color: var(--text-dim);
    }
    .steps strong { color: var(--text); font-weight: 500; }

    .platform-section { display: none; }
    .platform-section.active { display: block; }

    .success-banner {
      display: none; padding: 0.75rem 1rem; border-radius: 0.5rem;
      background: rgba(166, 227, 161, 0.15); border: 1px solid var(--success);
      color: var(--success); font-size: 0.8125rem; margin-bottom: 1rem;
      text-align: center;
    }
    .success-banner.visible { display: block; }

    .note {
      color: var(--text-dim); font-size: 0.75rem; line-height: 1.5;
      margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border);
    }

    .open-btn {
      display: none; align-items: center; justify-content: center;
      width: 100%; height: 2.75rem; border: none; border-radius: 0.5rem;
      background: var(--success); color: #1e1e2e;
      font-size: 0.875rem; font-family: var(--font-mono); font-weight: 500;
      cursor: pointer; text-decoration: none; margin-bottom: 1rem;
    }
    .open-btn.visible { display: flex; }
    .open-btn:active { opacity: 0.8; }

    .install-cmd {
      position: relative;
      background: var(--bg-input); border: 1px solid var(--border);
      border-radius: 0.5rem; padding: 0.75rem; margin-bottom: 1rem;
      font-size: 0.75rem; line-height: 1.6;
      word-break: break-all; color: var(--text);
      cursor: pointer;
    }
    .install-cmd:hover { border-color: var(--accent-active); }
    .install-cmd .copy-hint {
      display: block; color: var(--text-dim); font-size: 0.6875rem;
      margin-top: 0.375rem;
    }
    .install-cmd.copied .copy-hint { color: var(--success); }

    .or-divider {
      color: var(--text-dim); font-size: 0.75rem; text-align: center;
      margin: 1rem 0; position: relative;
    }
    .or-divider::before, .or-divider::after {
      content: ""; position: absolute; top: 50%;
      width: calc(50% - 1.5rem); height: 1px; background: var(--border);
    }
    .or-divider::before { left: 0; }
    .or-divider::after { right: 0; }

    .manual-toggle {
      background: none; border: none; color: var(--text-muted);
      font-size: 0.8125rem; font-family: var(--font-mono); cursor: pointer;
      padding: 0; text-decoration: underline; text-underline-offset: 2px;
      width: auto; height: auto; display: inline;
    }
    .manual-toggle:active { color: var(--text); }
  </style>
</head>
<body>
  <div class="trust-card">
    <h1>Trust Certificate</h1>
    <p class="subtitle">Install the Katulong CA certificate to enable secure HTTPS access on your local network.</p>

    <div class="success-banner" id="success-banner">
      Certificate is already trusted. You're all set.
    </div>

    <a class="open-btn" id="open-btn" href="#">Open Katulong (HTTPS)</a>

    <!-- iOS -->
    <div class="platform-section" id="ios-section">
      <a class="download-btn" href="/connect/trust/ca.mobileconfig" id="ios-download">Download Profile</a>
      <ol class="steps">
        <li data-step="1">Tap <strong>Download Profile</strong> above</li>
        <li data-step="2">Open <strong>Settings</strong> > <strong>General</strong> > <strong>VPN & Device Management</strong></li>
        <li data-step="3">Tap the <strong>Katulong Local CA</strong> profile and install it</li>
        <li data-step="4">Go to <strong>Settings</strong> > <strong>General</strong> > <strong>About</strong> > <strong>Certificate Trust Settings</strong></li>
        <li data-step="5">Enable full trust for <strong>Katulong Local CA</strong></li>
      </ol>
    </div>

    <!-- Android -->
    <div class="platform-section" id="android-section">
      <a class="download-btn" href="/connect/trust/ca.crt" id="android-download">Download Certificate</a>
      <ol class="steps">
        <li data-step="1">Tap <strong>Download Certificate</strong> above</li>
        <li data-step="2">Open <strong>Settings</strong> > <strong>Security</strong> > <strong>Encryption & credentials</strong></li>
        <li data-step="3">Tap <strong>Install a certificate</strong> > <strong>CA certificate</strong></li>
        <li data-step="4">Select the downloaded <strong>ca.crt</strong> file</li>
      </ol>
    </div>

    <!-- Desktop -->
    <div class="platform-section" id="desktop-section">
      <div id="install-cmd-section" style="display:none">
        <p style="color:var(--text-muted); font-size:0.8125rem; margin-bottom:0.75rem;">
          Run this in your terminal to set up <strong style="color:var(--text)">https://katulong.local</strong>:
        </p>
        <div class="install-cmd" id="install-cmd" role="button" tabindex="0" aria-label="Copy install command">
          <code id="install-cmd-text"></code>
          <span class="copy-hint">Click to copy</span>
        </div>
      </div>
      <div id="manual-section" style="display:none">
        <div class="or-divider">or</div>
        <p style="color:var(--text-muted); font-size:0.8125rem; margin-bottom:0.5rem;">
          Run these commands one at a time:
        </p>
        <div id="manual-commands"></div>
      </div>
      <button class="manual-toggle" id="manual-toggle">Manual install</button>
    </div>

    <p class="note">
      This is a private certificate generated by your Katulong instance. It only secures connections on your local network.
    </p>
  </div>

  <script>
    var httpsUrl = document.body.dataset.httpsUrl || '';
    var installCmd = document.body.dataset.installCmd || '';
    var lanIP = document.body.dataset.lanIp || '';
    var httpsPort = document.body.dataset.httpsPort || '443';
    var ua = navigator.userAgent || '';

    function copyText(text, cb) {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(cb).catch(function() { fallbackCopy(text, cb); });
      } else {
        fallbackCopy(text, cb);
      }
    }
    function fallbackCopy(text, cb) {
      var ta = document.createElement('textarea');
      ta.value = text;
      ta.style.position = 'fixed';
      ta.style.opacity = '0';
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
      cb();
    }
    function makeCopyable(el, text) {
      el.addEventListener('click', function() {
        copyText(text, function() {
          el.classList.add('copied');
          el.querySelector('.copy-hint').textContent = 'Copied!';
          setTimeout(function() {
            el.classList.remove('copied');
            el.querySelector('.copy-hint').textContent = 'Click to copy';
          }, 2000);
        });
      });
    }

    // Platform detection
    if (/iPad|iPhone|iPod/.test(ua)) {
      document.getElementById('ios-section').classList.add('active');
    } else if (/Android/.test(ua)) {
      document.getElementById('android-section').classList.add('active');
    } else {
      document.getElementById('desktop-section').classList.add('active');

      // Show install command if available
      if (installCmd) {
        document.getElementById('install-cmd-section').style.display = '';
        document.getElementById('install-cmd-text').textContent = installCmd;
        makeCopyable(document.getElementById('install-cmd'), installCmd);
      } else {
        // No install command — show manual steps directly
        document.getElementById('manual-section').style.display = '';
        document.getElementById('manual-toggle').style.display = 'none';
      }

      // Toggle manual section
      document.getElementById('manual-toggle').addEventListener('click', function() {
        var manual = document.getElementById('manual-section');
        manual.style.display = manual.style.display === 'none' ? '' : 'none';
      });

      // Build manual install commands based on platform
      if (lanIP) {
        var isMac = /Mac/.test(ua);
        var certUrl = location.origin + '/connect/trust/ca.crt';
        var commands = [];

        // Step 1: Download cert
        commands.push({ label: 'Download the CA certificate', cmd: 'curl -fsSL ' + certUrl + ' -o /tmp/katulong-ca.crt' });

        // Step 2: Install cert
        if (isMac) {
          commands.push({ label: 'Trust the certificate', cmd: 'sudo security add-trusted-cert -d -r trustRoot -k /Library/Keychains/System.keychain /tmp/katulong-ca.crt' });
        } else {
          commands.push({ label: 'Install the certificate', cmd: 'sudo cp /tmp/katulong-ca.crt /usr/local/share/ca-certificates/ && sudo update-ca-certificates' });
        }

        // Step 3: Add hosts entry
        commands.push({ label: 'Point katulong.local to this server', cmd: 'echo "' + lanIP + ' katulong.local" | sudo tee -a /etc/hosts' });

        // Step 4: Port forwarding (only if HTTPS is not already on 443)
        if (httpsPort !== '443') {
          if (isMac) {
            commands.push({ label: 'Forward port 443 to ' + httpsPort, cmd: 'printf "rdr pass on lo0 proto tcp from any to any port 443 -> 127.0.0.1 port ' + httpsPort + '\\nrdr pass proto tcp from any to ' + lanIP + ' port 443 -> ' + lanIP + ' port ' + httpsPort + '\\n" | sudo pfctl -a com.apple/katulong -f - 2>/dev/null; sudo pfctl -e 2>/dev/null' });
          } else {
            commands.push({ label: 'Forward port 443 to ' + httpsPort, cmd: 'sudo iptables -t nat -A PREROUTING -p tcp --dport 443 -j REDIRECT --to-port ' + httpsPort + ' && sudo iptables -t nat -A OUTPUT -o lo -p tcp --dport 443 -j REDIRECT --to-port ' + httpsPort });
          }
        }

        var cmdsEl = document.getElementById('manual-commands');
        for (var i = 0; i < commands.length; i++) {
          var label = document.createElement('p');
          label.style.cssText = 'color:var(--text-muted); font-size:0.75rem; margin:' + (i === 0 ? '0' : '0.75rem') + ' 0 0.375rem;';
          label.textContent = (i + 1) + '. ' + commands[i].label;
          cmdsEl.appendChild(label);

          var box = document.createElement('div');
          box.className = 'install-cmd';
          box.setAttribute('role', 'button');
          box.setAttribute('tabindex', '0');
          var code = document.createElement('code');
          code.textContent = commands[i].cmd;
          var hint = document.createElement('span');
          hint.className = 'copy-hint';
          hint.textContent = 'Click to copy';
          box.appendChild(code);
          box.appendChild(hint);
          cmdsEl.appendChild(box);
          makeCopyable(box, commands[i].cmd);
        }
      }
    }

    // Check if cert is trusted (poll every 3s until it is)
    if (httpsUrl) {
      var openBtn = document.getElementById('open-btn');
      openBtn.href = httpsUrl;
      var certTrusted = false;

      function checkCert() {
        if (certTrusted) return;
        fetch(httpsUrl + '/auth/status', { mode: 'no-cors' })
          .then(function() {
            certTrusted = true;
            document.getElementById('success-banner').classList.add('visible');
            openBtn.classList.add('visible');
          })
          .catch(function() {
            // Not trusted yet — retry
            setTimeout(checkCert, 3000);
          });
      }

      checkCert();
    }
  </script>
</body>
</html>
