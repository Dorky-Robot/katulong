<!DOCTYPE html>
<html lang="en" data-theme="auto">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#1e1e2e">
  <title>Katulong</title>
  <link rel="icon" href="/favicon.ico" sizes="32x32">
  <link rel="icon" href="/icon-192.png" type="image/png" sizes="192x192">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <link rel="manifest" href="/manifest.json">
  <!-- Self-hosted dependencies for security (no CDN trust needed) -->
  <link rel="stylesheet" href="/design-tokens.css">
  <link rel="stylesheet" href="/vendor/fonts/fonts.css">
  <link rel="stylesheet" href="/vendor/xterm/xterm.min.css">
  <link rel="stylesheet" href="/vendor/phosphor-icons/style.css">
  <script async src="/vendor/simple-peer/simplepeer.min.js"></script>
  <style>
    /* --- Catppuccin Mocha (dark) / Latte (light) --- */
    :root {
      --font-mono: 'JetBrains Mono', 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
      --bg: #1e1e2e;
      --bg-surface: #313244;
      --bg-input: #1e1e2e;
      --border: #45475a;
      --text: #cdd6f4;
      --text-muted: #a6adc8;
      --text-dim: #6c7086;
      --accent: #45475a;
      --accent-active: #cba6f7;
      --success: #a6e3a1;
      --warning: #f9e2af;
      --danger: #f38ba8;
      --overlay-bg: rgba(0,0,0,0.6);
      --focus-ring: rgba(137,180,250,0.5);
      --tag-bg: #45475a;
    }

    [data-theme="light"] {
      --bg: #eff1f5;
      --bg-surface: #ffffff;
      --bg-input: #e6e9ef;
      --border: #ccd0da;
      --text: #4c4f69;
      --text-muted: #6c6f85;
      --text-dim: #9ca0b0;
      --accent: #ccd0da;
      --accent-active: #8839ef;
      --success: #40a02b;
      --warning: #df8e1d;
      --danger: #d20f39;
      --overlay-bg: rgba(0,0,0,0.3);
      --focus-ring: rgba(30,102,245,0.4);
      --tag-bg: #dce0e8;
    }

    @media (prefers-color-scheme: light) {
      [data-theme="auto"] {
        --bg: #eff1f5;
        --bg-surface: #ffffff;
        --bg-input: #e6e9ef;
        --border: #ccd0da;
        --text: #4c4f69;
        --text-muted: #6c6f85;
        --text-dim: #9ca0b0;
        --accent: #ccd0da;
        --accent-active: #8839ef;
        --success: #40a02b;
        --warning: #df8e1d;
        --danger: #d20f39;
        --overlay-bg: rgba(0,0,0,0.3);
        --focus-ring: rgba(30,102,245,0.4);
        --tag-bg: #dce0e8;
      }
    }

    /* --- Reset & base --- */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    button, input { font-family: inherit; }
    html, body { height: 100%; background: var(--bg); overflow: hidden; color: var(--text); font-family: var(--font-mono); }

    /* --- Focus & motion --- */
    :focus-visible {
      outline: 2px solid var(--focus-ring);
      outline-offset: 2px;
    }
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        transition-duration: 0.01ms !important;
      }
    }

    /* --- Button System --- */
    .btn {
      height: var(--height-btn-md);
      padding: 0 1rem;
      border: none;
      border-radius: var(--radius-md);
      font-size: 0.875rem;
      font-family: inherit;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-xs);
      transition: background 0.15s ease, border-color 0.15s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    /* Button variants */
    .btn--primary {
      background: var(--accent);
      color: var(--text);
    }
    .btn--primary:active:not(:disabled) {
      background: var(--accent-active);
    }
    .btn--primary:disabled {
      opacity: var(--opacity-disabled);
      cursor: not-allowed;
    }

    .btn--secondary {
      background: var(--bg-input);
      color: var(--text-muted);
      border: 1px solid var(--border);
    }
    .btn--secondary:active:not(:disabled) {
      background: var(--accent);
      color: var(--text);
      border-color: var(--accent);
    }

    .btn--danger {
      background: var(--danger);
      color: var(--crust);
    }
    .btn--danger:active:not(:disabled) {
      background: var(--red);
    }

    .btn--ghost {
      background: transparent;
      color: var(--text);
      border: 1px dashed var(--border);
    }
    .btn--ghost:active:not(:disabled) {
      background: var(--accent);
      color: var(--text);
      border-color: var(--accent);
      border-style: solid;
    }

    /* Button sizes */
    .btn--sm {
      height: var(--height-btn-sm);
      padding: 0 var(--space-md);
      font-size: 0.75rem;
    }

    .btn--lg {
      height: 3rem;
      padding: 0 1.5rem;
      font-size: 0.9375rem;
    }

    /* Button modifiers */
    .btn--full {
      width: 100%;
    }

    .btn--icon-only {
      padding: 0;
      width: var(--height-btn-md);
    }
    .btn--icon-only.btn--sm {
      width: var(--height-btn-sm);
    }

    /* --- Terminal --- */
    #terminal-container { width: 100%; margin-top: 2.75rem; position: relative; z-index: 1; }
    #terminal-container .xterm { height: 100%; }
    #terminal-container .xterm-viewport {
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
    }

    /* --- Scroll to bottom --- */
    #scroll-bottom {
      position: fixed; bottom: 1rem; left: 1rem; z-index: 10;
      width: 2.5rem; height: 2.5rem; border-radius: 50%; border: none;
      background: var(--overlay-bg); color: var(--text); font-size: 1.25rem;
      cursor: pointer; display: none; align-items: center; justify-content: center;
      backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);
    }
    #scroll-bottom:active { opacity: 0.7; }

    /* --- Swipe feedback --- */
    .swipe-feedback {
      position: fixed; width: 48px; height: 48px; border-radius: 50%;
      background: var(--accent-active); opacity: 0; z-index: 10;
      pointer-events: none; transform: translate(-50%, -50%) scale(0.5);
      animation: swipe-pulse 0.35s ease-out forwards;
    }
    @keyframes swipe-pulse {
      0% { opacity: 0.5; transform: translate(-50%, -50%) scale(0.5); }
      100% { opacity: 0; transform: translate(-50%, -50%) scale(1.2); }
    }

    /* --- Shortcut bar --- */
    #shortcut-bar {
      position: fixed; top: 0; left: 0; right: 0; z-index: var(--z-bar);
      height: var(--height-btn-md); background: var(--bg-surface); border-bottom: 1px solid var(--border);
      transform: translate3d(0,0,0);
      display: flex; align-items: center; padding: 0 var(--space-1_5); gap: var(--space-xs);
      overflow-x: auto; overflow-y: hidden;
      -webkit-overflow-scrolling: touch;
    }
    #shortcut-bar::-webkit-scrollbar { display: none; }

    /* Toolbar color variants */
    #shortcut-bar[data-toolbar-color="blue"] { background: #89b4fa; border-bottom-color: #7aa2f7; color: #1e1e2e; }
    #shortcut-bar[data-toolbar-color="blue"] .session-btn { background: #7aa2f7; color: #1e1e2e; }
    #shortcut-bar[data-toolbar-color="blue"] .session-btn i { color: #1e1e2e; }
    #shortcut-bar[data-toolbar-color="blue"] .shortcut-btn,
    #shortcut-bar[data-toolbar-color="blue"] .bar-icon-btn { color: #1e1e2e; border-color: #6690e0; background: rgba(255,255,255,0.3); }
    #shortcut-bar[data-toolbar-color="blue"] #p2p-indicator { background: #1e1e2e; }
    #shortcut-bar[data-toolbar-color="blue"] #p2p-indicator.p2p-active { background: #40a02b; }
    #shortcut-bar[data-toolbar-color="blue"] #p2p-indicator.p2p-relay { background: #df8e1d; }

    #shortcut-bar[data-toolbar-color="purple"] { background: #cba6f7; border-bottom-color: #b4a1e8; color: #1e1e2e; }
    #shortcut-bar[data-toolbar-color="purple"] .session-btn { background: #b4a1e8; color: #1e1e2e; }
    #shortcut-bar[data-toolbar-color="purple"] .session-btn i { color: #1e1e2e; }
    #shortcut-bar[data-toolbar-color="purple"] .shortcut-btn,
    #shortcut-bar[data-toolbar-color="purple"] .bar-icon-btn { color: #1e1e2e; border-color: #a090d6; background: rgba(255,255,255,0.3); }
    #shortcut-bar[data-toolbar-color="purple"] #p2p-indicator { background: #1e1e2e; }
    #shortcut-bar[data-toolbar-color="purple"] #p2p-indicator.p2p-active { background: #40a02b; }
    #shortcut-bar[data-toolbar-color="purple"] #p2p-indicator.p2p-relay { background: #df8e1d; }

    #shortcut-bar[data-toolbar-color="green"] { background: #a6e3a1; border-bottom-color: #94d890; color: #1e1e2e; }
    #shortcut-bar[data-toolbar-color="green"] .session-btn { background: #94d890; color: #1e1e2e; }
    #shortcut-bar[data-toolbar-color="green"] .session-btn i { color: #1e1e2e; }
    #shortcut-bar[data-toolbar-color="green"] .shortcut-btn,
    #shortcut-bar[data-toolbar-color="green"] .bar-icon-btn { color: #1e1e2e; border-color: #7fc97a; background: rgba(255,255,255,0.3); }
    #shortcut-bar[data-toolbar-color="green"] #p2p-indicator { background: #1e1e2e; }
    #shortcut-bar[data-toolbar-color="green"] #p2p-indicator.p2p-active { background: #40a02b; }
    #shortcut-bar[data-toolbar-color="green"] #p2p-indicator.p2p-relay { background: #df8e1d; }

    #shortcut-bar[data-toolbar-color="red"] { background: #f38ba8; border-bottom-color: #e57996; color: #1e1e2e; }
    #shortcut-bar[data-toolbar-color="red"] .session-btn { background: #e57996; color: #1e1e2e; }
    #shortcut-bar[data-toolbar-color="red"] .session-btn i { color: #1e1e2e; }
    #shortcut-bar[data-toolbar-color="red"] .shortcut-btn,
    #shortcut-bar[data-toolbar-color="red"] .bar-icon-btn { color: #1e1e2e; border-color: #d66884; background: rgba(255,255,255,0.3); }
    #shortcut-bar[data-toolbar-color="red"] #p2p-indicator { background: #1e1e2e; }
    #shortcut-bar[data-toolbar-color="red"] #p2p-indicator.p2p-active { background: #40a02b; }
    #shortcut-bar[data-toolbar-color="red"] #p2p-indicator.p2p-relay { background: #df8e1d; }

    #shortcut-bar[data-toolbar-color="orange"] { background: #fab387; border-bottom-color: #f5a76e; color: #1e1e2e; }
    #shortcut-bar[data-toolbar-color="orange"] .session-btn { background: #f5a76e; color: #1e1e2e; }
    #shortcut-bar[data-toolbar-color="orange"] .session-btn i { color: #1e1e2e; }
    #shortcut-bar[data-toolbar-color="orange"] .shortcut-btn,
    #shortcut-bar[data-toolbar-color="orange"] .bar-icon-btn { color: #1e1e2e; border-color: #f09955; background: rgba(255,255,255,0.3); }
    #shortcut-bar[data-toolbar-color="orange"] #p2p-indicator { background: #1e1e2e; }
    #shortcut-bar[data-toolbar-color="orange"] #p2p-indicator.p2p-active { background: #40a02b; }
    #shortcut-bar[data-toolbar-color="orange"] #p2p-indicator.p2p-relay { background: #df8e1d; }

    #shortcut-bar[data-toolbar-color="pink"] { background: #f5c2e7; border-bottom-color: #f0b3de; color: #1e1e2e; }
    #shortcut-bar[data-toolbar-color="pink"] .session-btn { background: #f0b3de; color: #1e1e2e; }
    #shortcut-bar[data-toolbar-color="pink"] .session-btn i { color: #1e1e2e; }
    #shortcut-bar[data-toolbar-color="pink"] .shortcut-btn,
    #shortcut-bar[data-toolbar-color="pink"] .bar-icon-btn { color: #1e1e2e; border-color: #e8a4d5; background: rgba(255,255,255,0.3); }
    #shortcut-bar[data-toolbar-color="pink"] #p2p-indicator { background: #1e1e2e; }
    #shortcut-bar[data-toolbar-color="pink"] #p2p-indicator.p2p-active { background: #40a02b; }
    #shortcut-bar[data-toolbar-color="pink"] #p2p-indicator.p2p-relay { background: #df8e1d; }

    #shortcut-bar[data-toolbar-color="teal"] { background: #94e2d5; border-bottom-color: #81d8cc; color: #1e1e2e; }
    #shortcut-bar[data-toolbar-color="teal"] .session-btn { background: #81d8cc; color: #1e1e2e; }
    #shortcut-bar[data-toolbar-color="teal"] .session-btn i { color: #1e1e2e; }
    #shortcut-bar[data-toolbar-color="teal"] .shortcut-btn,
    #shortcut-bar[data-toolbar-color="teal"] .bar-icon-btn { color: #1e1e2e; border-color: #6ec9bc; background: rgba(255,255,255,0.3); }
    #shortcut-bar[data-toolbar-color="teal"] #p2p-indicator { background: #1e1e2e; }
    #shortcut-bar[data-toolbar-color="teal"] #p2p-indicator.p2p-active { background: #40a02b; }
    #shortcut-bar[data-toolbar-color="teal"] #p2p-indicator.p2p-relay { background: #df8e1d; }

    #shortcut-bar[data-toolbar-color="yellow"] { background: #f9e2af; border-bottom-color: #f5d99d; color: #1e1e2e; }
    #shortcut-bar[data-toolbar-color="yellow"] .session-btn { background: #f5d99d; color: #1e1e2e; }
    #shortcut-bar[data-toolbar-color="yellow"] .session-btn i { color: #1e1e2e; }
    #shortcut-bar[data-toolbar-color="yellow"] .shortcut-btn,
    #shortcut-bar[data-toolbar-color="yellow"] .bar-icon-btn { color: #1e1e2e; border-color: #f0ce8b; background: rgba(255,255,255,0.3); }
    #shortcut-bar[data-toolbar-color="yellow"] #p2p-indicator { background: #1e1e2e; }
    #shortcut-bar[data-toolbar-color="yellow"] #p2p-indicator.p2p-active { background: #40a02b; }
    #shortcut-bar[data-toolbar-color="yellow"] #p2p-indicator.p2p-relay { background: #df8e1d; }

    .shortcut-btn {
      flex-shrink: 0; height: var(--height-btn-sm); padding: 0 var(--space-md);
      border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--bg-input);
      color: var(--text); font-size: 0.8125rem; font-family: var(--font-mono);
      cursor: pointer; white-space: nowrap; display: flex; align-items: center; gap: var(--space-xs);
    }
    .shortcut-btn:active { background: var(--accent); }

    .session-btn {
      flex-shrink: 0; height: var(--height-btn-sm); padding: 0 var(--space-2_5);
      border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--accent);
      color: var(--text); font-size: 0.8125rem; font-family: var(--font-mono);
      cursor: pointer; white-space: nowrap; display: flex; align-items: center; gap: 0.375rem;
    }
    .session-btn:active { background: var(--accent-active); }

    .bar-icon-btn {
      flex-shrink: 0; height: var(--height-btn-sm); width: 2rem; padding: 0;
      border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--bg-input);
      color: var(--text-muted); font-size: 1.125rem; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
    }
    .bar-icon-btn:active { background: var(--accent); }
    .bar-spacer { margin-left: auto; }

    /* P2P status indicator */
    #p2p-indicator {
      flex-shrink: 0; width: 0.5rem; height: 0.5rem; border-radius: 50%;
      margin-right: 0.25rem;
      background: var(--text-dim); transition: background 0.2s;
    }
    #p2p-indicator.p2p-active { background: var(--success); }
    #p2p-indicator.p2p-relay { background: var(--warning); }

    /* --- Shared modal --- */
    .modal-overlay {
      display: none; position: fixed; z-index: var(--z-modal-bg);
      left: 0; right: 0;
      top: var(--viewport-top, 0px);
      height: var(--viewport-h, 100dvh);
      background: var(--overlay-bg);
      place-items: center;
      padding: max(1rem, env(safe-area-inset-top))
               max(1rem, env(safe-area-inset-right))
               max(1rem, env(safe-area-inset-bottom))
               max(1rem, env(safe-area-inset-left));
    }
    .modal-overlay.visible { display: grid; }
    .modal-panel {
      background: var(--bg-surface); overflow-y: auto;
      padding: 0 1.25rem;
      width: min(400px, 100%); max-height: 100%;
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
    }
    .modal-panel h3 {
      color: var(--text); font-size: 1rem; margin-bottom: 0.875rem; padding-top: 1rem;
    }

    /* --- Shortcuts popup --- */
    #shortcuts-overlay { z-index: var(--z-modal-bg); }
    .shortcuts-grid {
      display: flex; flex-direction: column; gap: var(--space-sm); padding-bottom: 0.5rem;
    }
    .shortcuts-grid .shortcut-btn {
      width: 100%; height: 3rem; justify-content: center; font-size: 0.9375rem;
    }
    .shortcuts-footer {
      display: flex; gap: var(--space-sm); padding: 0.75rem 0; position: sticky; bottom: 0;
      background: var(--bg-surface); border-top: 1px solid var(--border);
    }
    .shortcuts-footer button,
    .edit-actions button,
    .modal-actions button {
      flex: 1; /* Equal width in flex containers */
    }

    /* --- Edit panel --- */
    #edit-overlay { z-index: var(--z-modal-bg); }
    .edit-item {
      display: flex; align-items: center; gap: 0.625rem; padding: 0.625rem 0;
      border-bottom: 1px solid var(--border);
    }
    .edit-item-label {
      color: var(--text); font-size: 0.875rem; font-family: var(--font-mono); flex: 1;
      min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    .edit-item-keys {
      color: var(--text-muted); font-size: 0.75rem; font-family: var(--font-mono);
      flex-shrink: 0;
    }
    .edit-item-remove {
      width: 2.75rem; height: var(--height-btn-md); border: none; border-radius: var(--radius-md);
      background: transparent; color: var(--danger); font-size: 1.125rem; cursor: pointer;
      display: flex; align-items: center; justify-content: center; flex-shrink: 0;
    }
    .edit-item-remove:active { background: rgba(233,69,96,0.15); }
    .edit-actions {
      display: flex; gap: var(--space-sm); padding: 0.875rem 0; position: sticky; bottom: 0;
      background: var(--bg-surface);
    }
    /* Edit buttons now use .btn base classes - see Button System section */

    /* --- Add shortcut (tag composer) --- */
    #add-modal-overlay { z-index: var(--z-modal-panel); }
    .key-composer {
      display: flex; flex-wrap: wrap; align-items: center; gap: 0.375rem;
      min-height: 3rem; padding: 0.5rem 0.625rem;
      border: 1px solid var(--border); border-radius: var(--radius-md); background: var(--bg-input);
      margin-bottom: 0.75rem; cursor: text;
    }
    .key-composer:focus-within { border-color: var(--success); }
    .key-composer.invalid { animation: shake 0.3s; border-color: var(--danger); }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-4px); }
      75% { transform: translateX(4px); }
    }
    .key-tag {
      display: inline-flex; align-items: center; gap: var(--space-xs);
      height: 1.875rem; padding: 0 var(--space-2_5); border-radius: var(--radius-sm);
      background: var(--tag-bg); color: var(--text); font-size: 0.8125rem;
      font-family: var(--font-mono); white-space: nowrap;
    }
    .key-tag-remove {
      background: none; border: none; color: var(--text-muted); font-size: 0.875rem;
      cursor: pointer; padding: 0; margin-left: 0.125rem; line-height: 1;
      display: flex; align-items: center;
    }
    .key-tag-remove:active { color: var(--danger); }
    .key-comma {
      display: inline-flex; align-items: center; justify-content: center;
      color: var(--text-muted); font-size: 0.875rem; font-family: var(--font-mono);
      cursor: pointer; padding: 0 0.125rem;
    }
    /* --- Dictation modal --- */
    .dictation-input {
      width: 100%; min-height: 4rem; padding: 0.625rem;
      margin-top: 1rem;
      border: 1px solid var(--border); border-radius: var(--radius-sm);
      background: var(--bg); color: var(--text); font-size: 0.9375rem;
      font-family: var(--font-mono); resize: vertical;
      box-sizing: border-box;
    }
    .dictation-input::placeholder { color: var(--text-muted); }
    .dictation-images-btn {
      display: flex; align-items: center; gap: 0.375rem;
      height: 2.25rem; padding: 0 var(--space-md); margin-top: 0.625rem;
      border: 1px dashed var(--border); border-radius: var(--radius-sm);
      background: var(--bg-input); color: var(--text-muted);
      font-size: 0.8125rem; font-family: var(--font-mono); cursor: pointer;
    }
    .dictation-images-btn:active { background: var(--accent); }
    .dictation-thumbs {
      display: flex; flex-wrap: wrap; gap: var(--space-sm); margin-top: 0.625rem;
    }
    .dictation-thumb {
      position: relative; width: 3.5rem; height: 3.5rem; border-radius: var(--radius-sm);
      overflow: hidden; border: 1px solid var(--border);
    }
    .dictation-thumb img {
      width: 100%; height: 100%; object-fit: cover;
    }
    .dictation-thumb-remove {
      position: absolute; top: -0.25rem; right: -0.25rem;
      width: 1.25rem; height: 1.25rem; border-radius: 50%; border: none;
      background: var(--danger); color: #fff; font-size: 0.625rem;
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      line-height: 1;
    }
    .dictation-footer { display: flex; gap: var(--space-sm); padding: 0.75rem 0; }
    .dictation-send-btn {
      flex: 1; height: var(--height-btn-md); border: none; border-radius: var(--radius-md);
      background: var(--success); color: #1e1e2e; font-size: 0.875rem;
      font-family: var(--font-mono); cursor: pointer;
    }
    .dictation-send-btn:active { opacity: 0.8; }

    /* --- Joystick zone (touch devices only) --- */
    #joystick {
      display: none; position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 50;
      width: 5rem; height: 5rem; border-radius: 50%;
      border: 1.5px dashed var(--border);
      background: transparent;
      touch-action: none;
      align-items: center; justify-content: center;
    }
    #joystick::before {
      content: "+"; color: var(--text-dim); font-size: 1.25rem;
      pointer-events: none; opacity: 0.5;
    }
    @media (pointer: coarse) {
      #joystick { display: flex; }
    }

    /* --- Enter key progress ring --- */
    #enter-progress-ring {
      display: none;
      position: fixed;
      bottom: 1.5rem;
      right: 1.5rem;
      width: 5rem;
      height: 5rem;
      pointer-events: none;
      z-index: 51;
    }
    #enter-progress-ring.active {
      display: block;
    }
    #enter-progress-ring circle {
      fill: none;
      stroke: var(--accent);
      stroke-width: 3;
      stroke-linecap: round;
      transform: rotate(-90deg);
      transform-origin: center;
      opacity: 0.9;
    }

    /* --- Pull-up refresh indicator --- */
    #pull-refresh-indicator {
      position: fixed;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%) translateY(100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: var(--space-xs);
      padding: var(--space-lg);
      background: var(--accent);
      color: var(--bg);
      border-radius: 0.5rem 0.5rem 0 0;
      font-size: 0.875rem;
      font-family: var(--font-mono);
      pointer-events: none;
      z-index: 100;
      transition: transform 0.2s ease-out;
      opacity: 0;
    }
    #pull-refresh-indicator.visible {
      opacity: 1;
    }
    #pull-refresh-indicator i {
      font-size: 1.5rem;
    }

    .key-composer-input {
      flex: 1; min-width: 3.75rem; height: 1.875rem; border: none; background: transparent;
      color: var(--text); font-size: 0.875rem; font-family: var(--font-mono);
      outline: none;
    }
    .key-composer-input::placeholder { color: var(--text-dim); }
    .key-composer-hint {
      color: var(--text-dim); font-size: 0.6875rem; font-family: var(--font-mono);
      margin-bottom: 0.875rem; line-height: 1.4;
    }
    .key-preview {
      display: flex; align-items: center; gap: var(--space-xs); margin-bottom: 0.875rem;
      min-height: 1.5rem; color: var(--text-muted); font-size: 0.75rem;
      font-family: var(--font-mono);
    }
    .key-preview-label { color: var(--text-dim); }
    .modal-actions { display: flex; gap: var(--space-sm); padding-bottom: 1rem; }
    /* Modal action buttons now use .btn base classes - see Button System section */

    /* --- Session manager --- */
    #session-overlay { z-index: var(--z-modal-bg); }
    .session-item {
      display: flex; align-items: center; gap: 0.625rem; padding: 0.625rem 0;
      border-bottom: 1px solid var(--border);
    }
    .session-status { width: 0.5rem; height: 0.5rem; border-radius: 50%; flex-shrink: 0; }
    .session-status.alive { background: var(--success); }
    .session-status.dead { background: var(--text-muted); }
    .session-name-input {
      flex: 1; min-width: 0; height: 2.25rem; border: 1px solid transparent; border-radius: var(--radius-sm);
      background: transparent; color: var(--text); padding: 0 var(--space-sm);
      font-size: 0.875rem; font-family: var(--font-mono);
    }
    .session-name-input:focus {
      outline: none; border-color: var(--border); background: var(--bg-input);
    }
    .session-current-tag {
      color: var(--success); font-size: 0.625rem; flex-shrink: 0;
      font-family: var(--font-mono);
    }
    .session-icon-btn {
      width: 2.25rem; height: 2.25rem; border: none; border-radius: var(--radius-sm);
      background: transparent; font-size: 1.125rem; cursor: pointer; flex-shrink: 0;
      display: flex; align-items: center; justify-content: center;
    }
    .session-icon-btn.open { color: var(--text-muted); }
    .session-icon-btn.open:active { background: rgba(255,255,255,0.1); }
    .session-icon-btn.ssh { color: var(--text-muted); }
    .session-icon-btn.ssh:active { background: rgba(255,255,255,0.1); }
    .session-icon-btn.delete { color: var(--danger); }
    .session-icon-btn.delete:active { background: rgba(233,69,96,0.15); }
    .ssh-password-row {
      display: flex; align-items: center; justify-content: space-between;
      padding: 0.625rem 0; border-top: 1px solid var(--border); margin-top: 0.25rem;
    }
    .ssh-password-label {
      font-size: 0.75rem; color: var(--text-muted); font-family: var(--font-mono); flex-shrink: 0;
    }
    .ssh-password-field { display: flex; align-items: center; gap: var(--space-xs); }
    .ssh-password-input {
      width: 8rem; height: var(--height-btn-sm); border: 1px solid var(--border); border-radius: var(--radius-sm);
      background: var(--bg-input); color: var(--text); padding: 0 var(--space-sm);
      font-size: 0.75rem; font-family: var(--font-mono); letter-spacing: 0.1em;
    }
    .ssh-password-input:focus { outline: none; }
    .session-icon-btn.ssh-reveal { color: var(--text-muted); }
    .session-icon-btn.ssh-reveal:active { background: rgba(255,255,255,0.1); }
    .session-icon-btn.ssh-copy-pw { color: var(--text-muted); }
    .session-icon-btn.ssh-copy-pw:active { background: rgba(255,255,255,0.1); }
    .ssh-hint {
      font-size: 0.6875rem; color: var(--text-muted); font-family: var(--font-mono);
      padding: 0.375rem 0 0;
    }
    .ssh-hint kbd {
      display: inline-block; padding: 0.05rem 0.35rem; border: 1px solid var(--border);
      border-radius: 0.25rem; font-size: 0.625rem; font-family: var(--font-mono);
      background: var(--bg-input); line-height: 1.4;
    }
    .session-new-row {
      display: flex; gap: var(--space-sm); padding: 0.875rem 0;
      background: var(--bg-surface);
    }
    .session-new-input {
      flex: 1; height: var(--height-btn-md); border: 1px solid var(--border); border-radius: var(--radius-md);
      background: var(--bg-input); color: var(--text); padding: 0 var(--space-md); font-size: 0.875rem;
      font-family: var(--font-mono);
    }
    .session-new-btn {
      height: var(--height-btn-md); padding: 0 1rem; border: none; border-radius: var(--radius-md);
      background: var(--accent); color: var(--text); font-size: 0.875rem; cursor: pointer;
      display: flex; align-items: center; gap: 0.375rem;
    }
    .session-new-btn:active { background: var(--accent-active); }
    #session-panel {
      display: flex; flex-direction: column; max-height: min(80vh, 100%);
    }
    .session-scroll-area {
      overflow-y: auto; flex: 1; min-height: 0;
    }

    /* --- Settings modal --- */
    #settings-overlay { z-index: var(--z-modal-bg); }
    .settings-row {
      display: flex; align-items: center; justify-content: space-between;
      gap: var(--space-lg);
      padding: 0.75rem 0; border-bottom: 1px solid var(--border);
    }
    .settings-label {
      color: var(--text); font-size: 0.875rem; font-family: var(--font-mono);
    }
    .instance-name-input {
      flex: 1; max-width: 300px; height: var(--height-btn-sm); padding: 0 var(--space-md);
      border: 1px solid var(--border); border-radius: var(--radius-sm);
      background: var(--bg-input); color: var(--text); font-size: 0.875rem;
      font-family: var(--font-mono);
    }
    .instance-name-input:focus {
      outline: none; border-color: var(--accent);
    }
    .instance-icon-btn {
      display: flex; align-items: center; gap: var(--space-sm);
      height: var(--height-btn-sm); padding: 0 var(--space-md);
      border: 1px solid var(--border); border-radius: var(--radius-sm);
      background: var(--bg-input); color: var(--text); font-size: 0.75rem;
      font-family: var(--font-mono); cursor: pointer; transition: border-color 150ms ease;
    }
    .instance-icon-btn:hover {
      border-color: var(--accent);
    }
    .instance-icon-btn i {
      font-size: 1.25rem;
    }
    .icon-picker-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.5); z-index: var(--z-modal-nested);
      display: flex; align-items: center; justify-content: center;
    }
    .icon-picker-modal {
      background: var(--bg-surface); border: 1px solid var(--border);
      border-radius: var(--radius-md); width: min(600px, 90vw);
      max-height: 80vh; display: flex; flex-direction: column;
    }
    .icon-picker-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: var(--space-lg); border-bottom: 1px solid var(--border);
    }
    .icon-picker-header h3 {
      margin: 0; font-size: 1rem; font-weight: 500;
    }
    .icon-picker-close {
      background: none; border: none; color: var(--text-muted);
      cursor: pointer; padding: var(--space-xs); font-size: 1.25rem;
      display: flex; align-items: center; justify-content: center;
    }
    .icon-picker-close:hover {
      color: var(--text);
    }
    .icon-picker-content {
      padding: var(--space-lg); overflow-y: auto; flex: 1;
    }
    .icon-picker-category {
      margin-bottom: var(--space-xl);
    }
    .icon-picker-category:last-child {
      margin-bottom: 0;
    }
    .icon-picker-category h4 {
      margin: 0 0 var(--space-md) 0; font-size: 0.875rem;
      font-weight: 500; color: var(--text-muted);
    }
    .icon-picker-grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
      gap: var(--space-sm);
    }
    .icon-picker-icon {
      display: flex; align-items: center; justify-content: center;
      height: 60px; border: 1px solid var(--border); border-radius: var(--radius-sm);
      background: var(--bg); cursor: pointer; transition: all 150ms ease;
    }
    .icon-picker-icon:hover {
      border-color: var(--accent); background: var(--bg-surface);
    }
    .icon-picker-icon.selected {
      border-color: var(--accent); background: var(--accent);
    }
    .icon-picker-icon.selected i {
      color: white;
    }
    .icon-picker-icon i {
      font-size: 2rem; color: var(--text);
    }
    .toolbar-color-picker {
      display: flex; gap: var(--space-sm); flex-wrap: wrap;
    }
    .toolbar-color-swatch {
      width: 2.5rem; height: 2.5rem; border-radius: var(--radius-sm);
      border: 2px solid transparent; cursor: pointer;
      transition: all 150ms ease; position: relative;
    }
    .toolbar-color-swatch:hover {
      transform: scale(1.1); border-color: var(--text-dim);
    }
    .toolbar-color-swatch.selected {
      border-color: var(--accent-active); box-shadow: 0 0 0 2px var(--bg), 0 0 0 4px var(--accent-active);
    }
    .toolbar-color-swatch.selected::after {
      content: '✓'; position: absolute; top: 50%; left: 50%;
      transform: translate(-50%, -50%); color: white; font-weight: bold;
      text-shadow: 0 0 2px rgba(0,0,0,0.5);
    }
    .theme-toggle {
      display: flex; border: 1px solid var(--border); border-radius: var(--radius-sm); overflow: hidden;
    }
    .theme-toggle button {
      height: var(--height-btn-sm); padding: 0 var(--space-md); border: none; background: var(--bg-input);
      color: var(--text-muted); font-size: 0.75rem; font-family: var(--font-mono);
      cursor: pointer; border-right: 1px solid var(--border);
      display: flex; align-items: center; gap: var(--space-xs);
    }
    .theme-toggle button:last-child { border-right: none; }
    .theme-toggle button.active { background: var(--accent); color: var(--text); }
    .theme-toggle button:active { background: var(--accent-active); }
    .settings-footer {
      padding: 0.875rem 0;
    }
    .settings-logout-btn {
      width: 100%; height: var(--height-btn-md); border: none; border-radius: var(--radius-md);
      background: var(--danger); color: #fff; font-size: 0.875rem; cursor: pointer;
      margin-bottom: 0.5rem;
    }
    .settings-logout-btn:active { opacity: 0.8; }

    .settings-pair-btn {
      width: 100%; height: var(--height-btn-md); border: none; border-radius: var(--radius-md);
      background: var(--accent); color: var(--text); font-size: 0.875rem; cursor: pointer;
      margin-bottom: 0.5rem;
      display: flex; align-items: center; justify-content: center; gap: var(--space-sm);
    }
    .settings-pair-btn:active { background: var(--accent-active); }

    /* --- Settings tabs --- */
    .settings-tabs {
      display: flex;
      gap: var(--space-sm);
      margin-bottom: 1rem;
      border-bottom: 1px solid var(--border);
    }
    .settings-tab {
      padding: var(--space-sm) var(--space-lg);
      border: none;
      background: none;
      color: var(--text-muted);
      font-size: 0.875rem;
      font-family: var(--font-mono);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: color 0.2s, border-color 0.2s;
    }
    .settings-tab.active {
      color: var(--text);
      border-bottom-color: var(--accent-active);
    }
    .settings-tab:hover:not(.active) {
      color: var(--text);
    }
    .settings-tab-content {
      display: none;
    }
    .settings-tab-content.active {
      display: block;
    }

    /* --- Devices list --- */
    .devices-list {
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 1rem;
    }
    .devices-loading {
      color: var(--text-muted);
      font-size: 0.8125rem;
      text-align: center;
      padding: var(--space-2xl);
    }
    .device-section-header {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.5rem;
    }
    .device-item {
      padding: 0.875rem;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      margin-bottom: 0.75rem;
      background: var(--bg-input);
    }
    .device-item.current-device {
      border-color: var(--accent-active);
      background: var(--bg-surface);
    }
    .device-item-host {
      background: var(--bg-surface);
      border-color: var(--success);
      border-width: 2px;
    }
    .device-header {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      margin-bottom: 0.375rem;
    }
    .device-icon {
      font-size: 1.25rem;
    }
    .device-name {
      flex: 1;
      font-size: 0.875rem;
      color: var(--text);
      font-weight: 500;
    }
    .device-current-badge {
      font-size: 0.6875rem;
      color: var(--text-muted);
      background: var(--tag-bg);
      padding: 0.125rem 0.375rem;
      border-radius: 0.25rem;
    }
    .device-host-badge {
      font-size: 0.6875rem;
      color: var(--success);
      background: rgba(166, 227, 161, 0.15);
      padding: 0.125rem 0.375rem;
      border-radius: 0.25rem;
      font-weight: 600;
    }
    [data-theme="light"] .device-host-badge {
      background: rgba(64, 160, 43, 0.15);
    }
    .device-meta {
      color: var(--text-dim);
      font-size: 0.75rem;
      margin-bottom: 0.5rem;
    }
    .device-actions {
      display: flex;
      gap: var(--space-sm);
    }
    .device-btn {
      flex: 1;
      height: var(--height-btn-sm);
      border: none;
      border-radius: var(--radius-sm);
      background: var(--accent);
      color: var(--text);
      font-size: 0.75rem;
      cursor: pointer;
      font-family: var(--font-mono);
    }
    .device-btn:active { background: var(--accent-active); }
    .device-btn:disabled {
      opacity: var(--opacity-disabled);
      cursor: not-allowed;
    }
    .device-btn-danger {
      background: var(--danger);
      color: #fff;
    }
    .device-btn-danger:active { opacity: 0.8; }
    .devices-warning {
      color: var(--warning);
      font-size: 0.75rem;
      padding: var(--space-sm) var(--space-md);
      background: var(--bg-input);
      border-radius: var(--radius-sm);
      margin-top: 0.5rem;
      display: flex;
      align-items: center;
      gap: var(--space-sm);
    }

    /* --- Token list --- */
    .tab-description {
      color: var(--text-muted);
      font-size: 0.8125rem;
      margin-bottom: 1rem;
      line-height: 1.4;
    }
    .tokens-list {
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 1rem;
    }
    .tokens-loading {
      color: var(--text-muted);
      font-size: 0.8125rem;
      text-align: center;
      padding: var(--space-2xl);
    }
    .token-item {
      padding: 0.875rem;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      margin-bottom: 0.75rem;
      background: var(--bg-input);
    }
    .token-header {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      margin-bottom: 0.375rem;
    }
    .token-icon {
      font-size: 1.25rem;
      color: var(--accent);
    }
    .token-name {
      flex: 1;
      font-size: 0.875rem;
      color: var(--text);
      font-weight: 500;
    }
    .token-meta {
      color: var(--text-dim);
      font-size: 0.75rem;
      margin-bottom: 0.5rem;
      line-height: 1.4;
    }
    .token-status-active {
      display: inline-block;
      padding: 0.125rem 0.5rem;
      border-radius: 0.25rem;
      background: rgba(34, 197, 94, 0.15);
      color: rgb(34, 197, 94);
      font-size: 0.6875rem;
      font-weight: 500;
      margin-left: auto;
    }
    .token-status-unused {
      display: inline-block;
      padding: 0.125rem 0.5rem;
      border-radius: 0.25rem;
      background: var(--bg-surface);
      color: var(--text-muted);
      font-size: 0.6875rem;
      font-weight: 500;
      margin-left: auto;
    }
    .token-device-info {
      color: var(--text-muted);
      font-size: 0.6875rem;
    }
    .token-item-used {
      border-color: rgba(34, 197, 94, 0.3);
    }
    .token-actions {
      display: flex;
      gap: var(--space-sm);
    }
    .token-btn {
      flex: 1;
      height: var(--height-btn-sm);
      border: none;
      border-radius: var(--radius-sm);
      background: var(--accent);
      color: var(--text);
      font-size: 0.75rem;
      cursor: pointer;
      font-family: var(--font-mono);
    }
    .token-btn:active { background: var(--accent-active); }
    .token-btn-danger {
      background: var(--danger);
      color: #fff;
    }
    .token-btn-danger:active { opacity: 0.8; }
    .tokens-empty {
      color: var(--text-muted);
      font-size: 0.8125rem;
      text-align: center;
      padding: var(--space-2xl);
    }

    /* --- Token creation form (GitHub-style) --- */
    .token-create-form {
      background: var(--bg-surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: var(--space-lg);
      margin-bottom: 1rem;
    }
    .token-form-header h4 {
      margin: 0 0 1rem 0;
      font-size: 0.9375rem;
      font-weight: 600;
      color: var(--text);
    }
    .token-form-field {
      margin-bottom: 1rem;
    }
    .token-form-field label {
      display: block;
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--text);
      margin-bottom: 0.375rem;
    }
    .token-form-field input {
      width: 100%;
      padding: var(--space-sm) var(--space-md);
      font-size: 0.875rem;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text);
      font-family: var(--font-mono);
      outline: none;
    }
    .token-form-field input:focus {
      border-color: var(--accent);
    }
    .token-form-hint {
      font-size: 0.75rem;
      color: var(--text-dim);
      margin: var(--space-xs) 0 0 0;
    }
    .token-form-actions {
      display: flex;
      gap: var(--space-sm);
      justify-content: flex-end;
    }
    .token-form-cancel,
    .token-form-submit {
      padding: var(--space-sm) var(--space-lg);
      font-size: 0.8125rem;
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-family: var(--font-mono);
      font-weight: 500;
    }
    .token-form-cancel {
      background: transparent;
      color: var(--text-muted);
      border: 1px solid var(--border);
    }
    .token-form-cancel:hover {
      background: var(--bg-input);
    }
    .token-form-submit {
      background: var(--accent);
      color: var(--text);
    }
    .token-form-submit:hover {
      background: var(--accent-active);
    }
    .token-form-submit:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* --- New token display (1Password-style) --- */
    .token-item-new {
      border-color: var(--accent);
      background: var(--bg-surface);
      border-width: 2px;
    }
    .token-new-badge {
      font-size: 0.6875rem;
      color: var(--accent);
      background: rgba(116, 172, 223, 0.15);
      padding: 0.125rem 0.375rem;
      border-radius: 0.25rem;
      font-weight: 600;
    }
    .token-reveal-warning {
      color: var(--warning);
      font-size: 0.75rem;
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
      gap: var(--space-xs);
    }
    .token-value-container {
      display: flex;
      gap: var(--space-sm);
      align-items: center;
    }
    .token-value-field {
      flex: 1;
      font-family: var(--font-mono);
      font-size: 0.8125rem;
      padding: var(--space-sm) var(--space-md);
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text);
      outline: none;
    }
    .token-value-field:focus {
      border-color: var(--accent);
    }
    .token-copy-btn {
      height: var(--height-btn-sm);
      padding: 0 1rem;
      border: none;
      border-radius: var(--radius-sm);
      background: var(--accent);
      color: var(--text);
      font-size: 0.75rem;
      cursor: pointer;
      font-family: var(--font-mono);
      display: flex;
      align-items: center;
      gap: var(--space-xs);
      white-space: nowrap;
      transition: background 150ms ease;
    }
    .token-copy-btn:active {
      background: var(--accent-active);
    }

    /* --- Drop overlay --- */
    .drop-overlay {
      display: none; position: fixed; inset: 0; z-index: 20000;
      background: rgba(0,0,0,0.55); backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);
      place-items: center; font-size: 1.25rem; color: var(--text);
      font-family: var(--font-mono);
      border: 3px dashed var(--accent-active);
    }
    .drop-overlay.visible { display: grid; }

    /* --- Toast notifications --- */
    .toast {
      position: fixed; bottom: 3rem; left: 50%; transform: translateX(-50%);
      z-index: 20001; padding: var(--space-sm) var(--space-lg); border-radius: var(--radius-md);
      font-size: 0.8125rem; font-family: var(--font-mono);
      background: var(--bg-surface); color: var(--text); border: 1px solid var(--success);
      opacity: 0; transition: opacity 0.2s;
      pointer-events: none;
      max-width: 400px;
      text-align: center;
    }
    .toast.visible { opacity: 1; }
    .toast.toast-error { border-color: var(--danger); color: var(--danger); }

    /* Legacy upload toast */
    .upload-toast {
      position: fixed; bottom: 3rem; left: 50%; transform: translateX(-50%);
      z-index: 20001; padding: var(--space-sm) var(--space-lg); border-radius: var(--radius-md);
      font-size: 0.8125rem; font-family: var(--font-mono);
      background: var(--bg-surface); color: var(--text); border: 1px solid var(--border);
      opacity: 0; transition: opacity 0.2s;
      pointer-events: none;
    }
    .upload-toast.visible { opacity: 1; }
    .upload-toast.error { border-color: var(--danger); color: var(--danger); }

    /* --- Certificate management --- */
    .cert-ca-section {
      background: var(--bg-surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: var(--space-lg);
      margin-bottom: var(--space-xl);
    }
    .cert-ca-section h4 {
      margin: 0 0 var(--space-sm) 0;
      font-size: 0.95rem;
      color: var(--text);
    }
    .cert-ca-details {
      margin: var(--space-sm) 0;
      font-size: 0.875rem;
      color: var(--text-muted);
    }
    .cert-ca-details p {
      margin: 0.25rem 0;
    }
    .cert-ca-actions {
      margin-top: var(--space-md);
    }
    .btn-confirm {
      background: var(--warning) !important;
      color: var(--bg) !important;
    }
    .btn-confirm:hover {
      background: var(--warning) !important;
      opacity: 0.9;
    }
    .cert-networks-list {
      margin-bottom: var(--space-lg);
    }
    .cert-network-item {
      background: var(--bg-surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: var(--space-lg);
      margin-bottom: var(--space-md);
    }
    .cert-network-item.current {
      border-color: var(--success);
      border-width: 2px;
    }
    .cert-network-header {
      display: flex;
      align-items: center;
      gap: var(--space-md);
      margin-bottom: var(--space-sm);
    }
    .cert-network-label {
      flex: 1;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: var(--space-sm) var(--space-md);
      color: var(--text);
      font-size: 0.95rem;
      font-weight: 500;
    }
    .cert-network-label:focus {
      outline: none;
      border-color: var(--accent-active);
    }
    .cert-network-details {
      margin: var(--space-sm) 0;
      font-size: 0.875rem;
      color: var(--text-muted);
    }
    .cert-network-details p {
      margin: 0.25rem 0;
    }
    .cert-network-actions {
      display: flex;
      gap: var(--space-sm);
      margin-top: var(--space-md);
    }
    .btn-small {
      padding: var(--space-sm) var(--space-md);
      background: var(--accent);
      color: var(--text);
      border: none;
      border-radius: var(--radius-sm);
      font-size: 0.875rem;
      cursor: pointer;
      transition: background 0.2s;
    }
    .btn-small:hover {
      background: var(--accent-active);
      color: var(--bg);
    }
    .btn-danger {
      background: var(--danger);
      color: white;
    }
    .btn-danger:hover {
      background: #c82333;
    }
    .badge {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      background: var(--accent-active);
      color: var(--bg);
      border-radius: var(--radius-sm);
      font-size: 0.75rem;
      font-weight: 600;
    }
    .warning {
      color: var(--warning);
    }

  </style>
</head>
<body>
  <div id="terminal-container"></div>
  <div id="drop-overlay" class="drop-overlay">Drop image here</div>
  <button id="scroll-bottom" aria-label="Scroll to bottom">
    <i class="ph ph-caret-down"></i>
  </button>
  <nav id="shortcut-bar" role="toolbar" aria-label="Shortcut bar"></nav>

  <!-- Edit shortcuts -->
  <div id="edit-overlay" class="modal-overlay" role="dialog" aria-label="Edit shortcuts">
    <div id="edit-panel" class="modal-panel">
      <h3>Edit Shortcuts</h3>
      <div id="edit-list" role="list"></div>
      <div class="edit-actions">
        <button class="btn btn--ghost" id="edit-add">
          <i class="ph ph-plus"></i> Add
        </button>
        <button class="btn btn--primary" id="edit-done">Done</button>
      </div>
    </div>
  </div>

  <!-- Add shortcut (tag composer) -->
  <div id="add-modal-overlay" class="modal-overlay" role="dialog" aria-label="Add shortcut">
    <div id="add-modal" class="modal-panel">
      <h3>Add Shortcut</h3>
      <div id="key-composer" class="key-composer" role="group" aria-label="Key composer">
        <input type="text" id="key-composer-input" class="key-composer-input"
          placeholder="type a key..." autocorrect="off" autocapitalize="off"
          autocomplete="off" spellcheck="false" aria-label="Key name input">
      </div>
      <div class="key-composer-hint" aria-hidden="true">
        ctrl, cmd, alt, shift, a-z, 0-9, esc, tab, enter, space, backspace, up, down, left, right — use , (comma) to chain sequences
      </div>
      <div class="key-preview" aria-live="polite">
        <span class="key-preview-label">Sends:</span>
        <span id="key-preview-value"></span>
      </div>
      <div class="modal-actions">
        <button class="btn btn--secondary" id="modal-cancel">Cancel</button>
        <button class="btn btn--primary" id="modal-save" disabled>Add</button>
      </div>
    </div>
  </div>

  <!-- Sessions -->
  <div id="session-overlay" class="modal-overlay" role="dialog" aria-label="Session manager">
    <div id="session-panel" class="modal-panel">
      <h3>Sessions</h3>
      <div class="session-scroll-area">
      <div id="session-list" role="list"></div>
      <div class="ssh-password-row" id="ssh-password-row">
        <span class="ssh-password-label">SSH password</span>
        <div class="ssh-password-field">
          <input type="password" id="ssh-password-value" readonly class="ssh-password-input" value="" aria-label="SSH password">
          <button class="session-icon-btn ssh-reveal" id="ssh-password-reveal" aria-label="Toggle password visibility">
            <i class="ph ph-eye"></i>
          </button>
          <button class="session-icon-btn ssh-copy-pw" id="ssh-password-copy" aria-label="Copy SSH password">
            <i class="ph ph-copy"></i>
          </button>
        </div>
      </div>
      <div class="ssh-hint">Disconnect: <kbd>Enter</kbd> <kbd>~</kbd> <kbd>.</kbd></div>
      </div>
      <div class="session-new-row">
        <input type="text" class="session-new-input" id="session-new-name"
          placeholder="new-session-name" autocorrect="off" autocapitalize="off"
          spellcheck="false" aria-label="New session name">
        <button class="session-new-btn" id="session-new-create">
          <i class="ph ph-plus"></i> New
        </button>
      </div>
    </div>
  </div>

  <!-- Shortcuts popup -->
  <div id="shortcuts-overlay" class="modal-overlay" role="dialog" aria-label="Shortcuts">
    <div id="shortcuts-panel" class="modal-panel">
      <h3>Shortcuts</h3>
      <div id="shortcuts-grid" class="shortcuts-grid" role="list"></div>
      <div class="shortcuts-footer">
        <button class="btn btn--secondary" id="shortcuts-edit-btn">
          <i class="ph ph-pencil-simple"></i> Edit
        </button>
      </div>
    </div>
  </div>

  <!-- Dictation modal -->
  <div id="dictation-overlay" class="modal-overlay" role="dialog" aria-label="Dictation">
    <div class="modal-panel">
      <textarea id="dictation-input" class="dictation-input"
        rows="3" placeholder="type..." autocorrect="off" autocapitalize="off"
        autocomplete="off" spellcheck="false" aria-label="Dictation input"></textarea>
      <label for="dictation-file-input" class="dictation-images-btn">
        <i class="ph ph-image"></i> Add Images
      </label>
      <input type="file" id="dictation-file-input" accept="image/*" multiple hidden>
      <div class="dictation-thumbs" id="dictation-thumbs"></div>
      <div class="dictation-footer">
        <button class="dictation-send-btn" id="dictation-send">Send</button>
      </div>
    </div>
  </div>

  <!-- Joystick swipe zone -->
  <div id="joystick" aria-label="Swipe or hold joystick for arrows, long-press center for Enter"></div>

  <!-- Enter key progress ring -->
  <svg id="enter-progress-ring" viewBox="0 0 80 80">
    <circle cx="40" cy="40" r="36" />
  </svg>

  <!-- Pull-up refresh indicator -->
  <div id="pull-refresh-indicator">
    <i class="ph ph-arrow-up"></i>
    <span>Release to refresh</span>
  </div>

  <!-- Settings -->
  <div id="settings-overlay" class="modal-overlay" role="dialog" aria-label="Settings">
    <div id="settings-panel" class="modal-panel">
      <div id="settings-views" class="settings-views">
        <!-- View 0: Main settings -->
        <div class="settings-view active" id="settings-view-main">
          <h3>Settings</h3>

          <!-- Tab navigation -->
          <div class="settings-tabs" role="tablist">
            <button class="settings-tab active" data-tab="theme" role="tab" aria-selected="true">Theme</button>
            <button class="settings-tab" data-tab="lan" role="tab" aria-selected="false">Devices</button>
            <button class="settings-tab" data-tab="remote" role="tab" aria-selected="false">Remote</button>
            <button class="settings-tab" data-tab="certificates" role="tab" aria-selected="false">Certificates</button>
          </div>

          <!-- Theme tab content -->
          <div class="settings-tab-content active" id="settings-tab-theme">
            <div class="settings-row">
              <span class="settings-label">Instance Name</span>
              <input type="text" id="instance-name-input" class="instance-name-input" placeholder="My Katulong" maxlength="100" />
            </div>
            <p class="tab-description" style="margin-top: 0.5rem; margin-bottom: 1.5rem;">
              This name helps you identify this Katulong instance when you have multiple devices.
            </p>

            <div class="settings-row">
              <span class="settings-label">Instance Icon</span>
              <button class="instance-icon-btn" id="instance-icon-btn" type="button">
                <i class="ph ph-terminal-window" id="instance-icon-display"></i>
                <span>Change</span>
              </button>
            </div>
            <p class="tab-description" style="margin-top: 0.5rem; margin-bottom: 1.5rem;">
              Choose an icon to visually identify this instance.
            </p>

            <div class="settings-row">
              <span class="settings-label">Toolbar Color</span>
              <div class="toolbar-color-picker" id="toolbar-color-picker"></div>
            </div>
            <p class="tab-description" style="margin-top: 0.5rem; margin-bottom: 1.5rem;">
              Choose a color for the toolbar.
            </p>

            <div class="settings-row">
              <span class="settings-label">Theme</span>
              <div class="theme-toggle" role="radiogroup" aria-label="Theme selection">
                <button data-theme-val="auto" role="radio" aria-checked="true">
                  <i class="ph ph-circle-half"></i> Auto
                </button>
                <button data-theme-val="light" role="radio" aria-checked="false">
                  <i class="ph ph-sun"></i> Light
                </button>
                <button data-theme-val="dark" role="radio" aria-checked="false">
                  <i class="ph ph-moon"></i> Dark
                </button>
              </div>
            </div>
          </div>

          <!-- Devices tab content -->
          <div class="settings-tab-content" id="settings-tab-lan">
            <div class="devices-list" id="devices-list">
              <p class="devices-loading">Loading devices...</p>
            </div>
          </div>

          <!-- Remote tab content -->
          <div class="settings-tab-content" id="settings-tab-remote">
            <p class="tab-description">Manage setup tokens for pairing devices remotely (e.g., via ngrok).</p>

            <!-- Inline token creation form (GitHub-style) -->
            <div class="token-create-form" id="token-create-form" style="display: none;">
              <div class="token-form-header">
                <h4>Generate new setup token</h4>
              </div>
              <div class="token-form-field">
                <label for="token-name-input">Token name</label>
                <input type="text" id="token-name-input" placeholder="e.g., Personal MacBook, Work laptop" />
                <p class="token-form-hint">What's this token for?</p>
              </div>
              <div class="token-form-actions">
                <button class="token-form-cancel" id="token-form-cancel">Cancel</button>
                <button class="token-form-submit" id="token-form-submit">Generate token</button>
              </div>
            </div>

            <div class="tokens-list" id="tokens-list">
              <p class="tokens-loading">Loading tokens...</p>
            </div>
            <button class="settings-pair-btn" id="settings-create-token">
              <i class="ph ph-plus"></i> Generate New Token
            </button>
          </div>

          <!-- Certificates tab content -->
          <div class="settings-tab-content" id="settings-tab-certificates">
            <p class="tab-description">Manage TLS certificates for each network.</p>

            <!-- Networks List -->
            <div class="cert-networks-list">
              <div id="cert-networks-container">
                <p style="color: var(--text-muted)">Loading networks...</p>
              </div>
            </div>

            <!-- Generate for Current Network -->
            <button class="settings-pair-btn" id="cert-generate-current" style="display: none;">
              <i class="ph ph-plus"></i> Generate Certificate for Current Network
            </button>
          </div>

          <div class="settings-footer">
            <button class="settings-logout-btn" id="settings-logout">End Session</button>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Icon Picker Modal -->
  <div class="icon-picker-overlay" id="icon-picker-overlay" style="display: none;">
    <div class="icon-picker-modal">
      <div class="icon-picker-header">
        <h3>Choose an Icon</h3>
        <button class="icon-picker-close" id="icon-picker-close" aria-label="Close">
          <i class="ph ph-x"></i>
        </button>
      </div>
      <div class="icon-picker-content">
        <div class="icon-picker-category">
          <h4>Computers & Devices</h4>
          <div class="icon-picker-grid" data-category="computersdevices"></div>
        </div>
        <div class="icon-picker-category">
          <h4>Locations</h4>
          <div class="icon-picker-grid" data-category="locations"></div>
        </div>
        <div class="icon-picker-category">
          <h4>Objects & Symbols</h4>
          <div class="icon-picker-grid" data-category="objectssymbols"></div>
        </div>
      </div>
    </div>
  </div>

  <script type="module" src="/app.js?v=16"></script>
</body>
</html>
