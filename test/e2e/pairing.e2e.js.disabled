import { test, expect } from "@playwright/test";

test.describe("Device pairing flow", () => {
  test("Complete pairing flow - generate code, enter PIN, verify redirect", async ({ page, request }) => {
    // Step 1: Start pairing challenge (requires auth - localhost auto-auth)
    const pairStartResponse = await request.post("http://localhost:3001/auth/pair/start", {
      headers: {
        "Content-Type": "application/json",
      }
    });

    expect(pairStartResponse.ok()).toBeTruthy();
    const pairData = await pairStartResponse.json();

    console.log("Pairing challenge created:", {
      code: pairData.code,
      pin: pairData.pin,
      expiresAt: pairData.expiresAt
    });

    expect(pairData.code).toBeTruthy();
    expect(pairData.pin).toBeTruthy();
    expect(pairData.pin).toMatch(/^\d{8}$/); // 8-digit PIN

    // Step 2: Navigate to pairing page with code
    await page.goto(`https://localhost:3002/pair?code=${pairData.code}`);

    // Step 3: Verify page loaded correctly
    await expect(page.locator("h1")).toHaveText("Pair Device");
    await expect(page.locator(".subtitle")).toContainText("8-digit PIN");

    // Step 4: Verify debug log is visible (shows JS loaded)
    const debugLog = page.locator("#debug-log");
    await expect(debugLog).toBeVisible();

    // Wait for page to initialize and show initial log
    await page.waitForTimeout(500);
    const debugText = await debugLog.textContent();
    console.log("Debug log content:", debugText);
    expect(debugText).toContain("Page loaded");

    // Step 5: Enter PIN
    const pinInput = page.locator("#pin-input");
    await pinInput.fill(pairData.pin);

    // Step 6: Click Confirm button
    const confirmBtn = page.locator("#pair-btn");
    await expect(confirmBtn).toBeEnabled();
    await confirmBtn.click();

    // Step 7: Wait for debug log to show progress
    await page.waitForTimeout(1000);
    const debugAfterSubmit = await debugLog.textContent();
    console.log("Debug log after submit:", debugAfterSubmit);

    // Check for either success or error in debug log
    if (debugAfterSubmit.includes("ERROR")) {
      // If there's an error, log it and fail
      console.error("Pairing failed with error:", debugAfterSubmit);
      throw new Error(`Pairing failed: ${debugAfterSubmit}`);
    }

    // Step 8: Should redirect to / on success
    await page.waitForURL("/", { timeout: 5000 });

    // Step 9: Verify we're on the main page with a session cookie
    const cookies = await page.context().cookies();
    const sessionCookie = cookies.find(c => c.name === "katulong_session");
    expect(sessionCookie).toBeTruthy();
    console.log("Session cookie set:", sessionCookie.value.substring(0, 16) + "...");

    // Step 10: Verify terminal is visible (authenticated)
    await expect(page.locator("#terminal")).toBeVisible();
  });

  test("Shows error for wrong PIN", async ({ page, request }) => {
    // Step 1: Start pairing challenge
    const pairStartResponse = await request.post("http://localhost:3001/auth/pair/start");
    const pairData = await pairStartResponse.json();

    // Step 2: Navigate to pairing page
    await page.goto(`https://localhost:3002/pair?code=${pairData.code}`);

    // Step 3: Enter WRONG PIN
    const pinInput = page.locator("#pin-input");
    await pinInput.fill("12345678"); // Wrong PIN

    // Step 4: Click Confirm
    await page.locator("#pair-btn").click();

    // Step 5: Wait for error to appear
    await page.waitForTimeout(1000);

    // Step 6: Check for error in debug log or error message
    const debugLog = await page.locator("#debug-log").textContent();
    const errorMsg = await page.locator("#pair-error").textContent();

    console.log("Debug log:", debugLog);
    console.log("Error message:", errorMsg);

    // Should show error (either in debug log or error element)
    const hasError = debugLog.includes("ERROR") || errorMsg.length > 0;
    expect(hasError).toBeTruthy();

    // Should NOT redirect (still on pairing page)
    expect(page.url()).toContain("/pair");
  });

  test("Shows error for expired code", async ({ page, request }) => {
    // Step 1: Start pairing challenge
    const pairStartResponse = await request.post("http://localhost:3001/auth/pair/start");
    const pairData = await pairStartResponse.json();

    // Step 2: Navigate to pairing page
    await page.goto(`https://localhost:3002/pair?code=${pairData.code}`);

    // Step 3: Wait for code to expire (30 seconds + buffer)
    console.log("Waiting for pairing code to expire (31 seconds)...");
    await page.waitForTimeout(31000);

    // Step 4: Enter correct PIN (but code is expired)
    await page.locator("#pin-input").fill(pairData.pin);
    await page.locator("#pair-btn").click();

    // Step 5: Should show error
    await page.waitForTimeout(1000);
    const debugLog = await page.locator("#debug-log").textContent();
    const errorMsg = await page.locator("#pair-error").textContent();

    console.log("Debug log:", debugLog);
    console.log("Error message:", errorMsg);

    const hasError = debugLog.includes("ERROR") || errorMsg.length > 0;
    expect(hasError).toBeTruthy();

    // Should NOT redirect
    expect(page.url()).toContain("/pair");
  });

  test("Pairing page loads with no-cache headers", async ({ page }) => {
    // Generate a pairing code first
    const pairStartResponse = await page.request.post("http://localhost:3001/auth/pair/start");
    const pairData = await pairStartResponse.json();

    // Navigate to pairing page and check response headers
    const response = await page.goto(`https://localhost:3002/pair?code=${pairData.code}`);
    const headers = response.headers();

    console.log("Response headers:", headers);

    // Verify no-cache headers are present
    expect(headers["cache-control"]).toContain("no-store");
    expect(headers["cache-control"]).toContain("no-cache");
    expect(headers["pragma"]).toBe("no-cache");
  });
});
